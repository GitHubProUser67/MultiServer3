using QuazalServer.RDVServices.DDL.Models;
using QuazalServer.QNetZ;
using QuazalServer.QNetZ.Attributes;
using QuazalServer.QNetZ.DDL;
using QuazalServer.QNetZ.Interfaces;
using QuazalServer.RDVServices.RMC;
using Alcatraz.Context.Entities;
using Newtonsoft.Json;
using RDVServices;
using CustomLogger;
using Microsoft.EntityFrameworkCore;

namespace QuazalServer.RDVServices.GameServices.PS3GFRSServices
{
    [RMCService((ushort)RMCProtocolId.PlayerStatsService)]
    public class PlayerStatisticsService : RMCServiceBase
    {
        //public static List<StatisticsBoard> StatisticsBoards = new List<StatisticsBoard>();

        [RMCMethod(1)]
        public void PostTwitterMessage(string message)
        {
            UNIMPLEMENTED();
        }

        [RMCMethod(2)]
        public RMCResult WritePlayerStats(IEnumerable<StatisticWriteWithBoard> playerStats)
        {
            var playerId = Context.Client.PlayerInfo.PID;

            using (var db = DBHelper.GetDbContext(Context.Handler.Factory.Item1))
            {
                foreach (var writeBoard in playerStats)
                {
                    var playerBoard = db.PlayerStatisticBoards
                        .FirstOrDefault(x => x.PlayerId == playerId && x.BoardId == writeBoard.boardId);

                    if (playerBoard == null)
                    {
                        playerBoard = SeedStatistics.GeneratePlayerBoard(writeBoard.boardId, playerId);
                        db.Add(playerBoard);
                        db.SaveChanges();
                    }

                    // avoid Client evaluation simply by converting it into int array
                    var propertyIdsOnly = writeBoard.statisticList.Select(ws => (int)ws.propertyId).ToArray();

                    var existingBoardValues = db.PlayerStatisticBoardValues
                        .Where(x => propertyIdsOnly.Contains(x.PropertyId) && x.PlayerBoardId == playerBoard.Id)
                        .ToArray();

                    float newBoardScore = 0.0f;

                    foreach (var writeStat in writeBoard.statisticList)
                    {
                        var existingVariantJSON = existingBoardValues.FirstOrDefault(x => x.PropertyId == writeStat.propertyId);

                        if (existingVariantJSON != null)
                        {
                            var valueToUpdate = new StatisticsBoardValue()
                            {
                                value = JsonConvert.DeserializeObject<StatisticValueVariant>(existingVariantJSON.ValueJSON),
                                rankingCriterionIndex = (byte)existingVariantJSON.RankingCriterionIndex,
                                scoreLostForNextSlice = JsonConvert.DeserializeObject<StatisticValueVariant>(existingVariantJSON.ScoreLostForNextSliceJSON),
                                sliceScore = JsonConvert.DeserializeObject<StatisticValueVariant>(existingVariantJSON.SliceScoreJSON)
                            };

                            // Update variant value
                            if (valueToUpdate.UpdateValueWithPolicy(writeStat.value, (StatisticPolicy)writeStat.writePolicy))
                            {
                                var statDesc = SeedStatistics.AllStatisticDescriptions.FirstOrDefault(x => x.statBoard == writeBoard.boardId && x.statInBoardId == writeStat.propertyId);
                                LoggerAccessor.LogInfo($"[PlayerStatisticsService] - player {Context.Client.PlayerInfo.Name} {statDesc.statName} ({writeBoard.boardId}:{writeStat.propertyId}) changed to '{writeStat.value.ToString()}' with policy {(StatisticPolicy)writeStat.writePolicy}");
                            }

                            newBoardScore += (float)valueToUpdate.value.GetAsFloat();

                            // put back the values
                            existingVariantJSON.RankingCriterionIndex = valueToUpdate.rankingCriterionIndex;
                            existingVariantJSON.ValueJSON = JsonConvert.SerializeObject(valueToUpdate.value);
                            existingVariantJSON.ScoreLostForNextSliceJSON = JsonConvert.SerializeObject(valueToUpdate.scoreLostForNextSlice);
                            existingVariantJSON.SliceScoreJSON = JsonConvert.SerializeObject(valueToUpdate.sliceScore);

                            continue;
                        }

                        LoggerAccessor.LogWarn($"[PlayerStatisticsService] - stats property id ({writeBoard.boardId}:{writeStat.propertyId}) was not found, creating new one...");

                        var newBoardValue = SeedStatistics.GetStatisticBoardValueByPropertyId(writeBoard.boardId, writeStat.propertyId);
                        if (newBoardValue != null)
                        {
                            newBoardValue.value = writeStat.value;

                            var newVariantJSON = new PlayerStatisticsBoardValue()
                            {
                                PropertyId = writeStat.propertyId,
                                RankingCriterionIndex = newBoardValue.rankingCriterionIndex,
                                ValueJSON = JsonConvert.SerializeObject(newBoardValue.value),
                                ScoreLostForNextSliceJSON = JsonConvert.SerializeObject(newBoardValue.scoreLostForNextSlice),
                                SliceScoreJSON = JsonConvert.SerializeObject(newBoardValue.sliceScore)
                            };

                            db.PlayerStatisticBoardValues.Add(newVariantJSON);
                        }
                        else
                        {
                            LoggerAccessor.LogWarn($"[PlayerStatisticsService] - UNKNOWN stats property id ({writeBoard.boardId}:{writeStat.propertyId})");
                        }
                    }

                    playerBoard.LastUpdate = DateTime.UtcNow;
                    playerBoard.Score = newBoardScore;

                    //UpdateBoardScoreAndRank(playerBoard);
                    {
                        // playerBoard.PlayerId

                    }
                }
                /*
				// after score is calculated, recalc the rank
				foreach (var writeBoard in playerStats)
				{
					var leaderBoardStat = SeedStatistics.AllStatisticDescriptions.FirstOrDefault(x => x.statBoard == writeBoard.boardId && x.statInBoardId == writeBoard.columnId);
					if (leaderBoardStat.statRankingOrder == RankingOrder.Ascending)
						playerStats.Sort((a, b) => (int)(a.scoresByBoard.First().score - b.scoresByBoard.First().score));
					else
						playerStats.Sort((a, b) => (int)(b.scoresByBoard.First().score - a.scoresByBoard.First().score));

					var playerBoards = db.PlayerStatisticBoards.Where(x => x.BoardId == writeBoard.boardId).OrderByDescending(x => x.Score);

					var playerBoard = db.PlayerStatisticBoards
						.FirstOrDefault(x => x.PlayerId == playerId && x.BoardId == writeBoard.boardId);


					playerBoard.Rank = db.PlayerStatisticBoards.Where(x => x.BoardId == writeBoard.boardId).Select(x => x.Score).OrderByDescending();
				}*/

                db.SaveChanges();
            }

            return Error(0);
        }

        [RMCMethod(3)]
        public void WritePlayerStatsWithFriendsComparison(IEnumerable<StatisticWriteWithBoard> playerStats, List<uint> playerPIDs)
        {
            UNIMPLEMENTED();
        }

        [RMCMethod(4)]
        public RMCResult ReadPlayerStats(IEnumerable<StatisticData> data, List<uint> playerIds)
        {
            var playerStats = new List<ScoreListRead>();

            int i = 0;
            const int MAX_STAT_PLAYERS_OR_FRIENDS_LIST_WILL_CRASH = 16;

            foreach (var playerId in playerIds)
            {
                // Until we fix the game executable this remains here
                if (++i > MAX_STAT_PLAYERS_OR_FRIENDS_LIST_WILL_CRASH)
                    break;

                var player = NetworkPlayers.GetPlayerInfoByPID(playerId);

                if (player == null)
                    continue;

                var scoreListRead = new ScoreListRead()
                {
                    pid = playerId,
                    pname = player.Name
                };
                playerStats.Add(scoreListRead);

                using (var db = DBHelper.GetDbContext(Context.Handler.Factory.Item1))
                {
                    foreach (var statReqData in data)
                    {
                        var playerBoard = db.PlayerStatisticBoards
                            .Include(x => x.Values)
                            .FirstOrDefault(x => x.PlayerId == playerId && x.BoardId == statReqData.boardId);

                        // create empty one
                        if (playerBoard == null)
                        {
                            playerBoard = SeedStatistics.GeneratePlayerBoard(statReqData.boardId, playerId);
                            db.Add(playerBoard);
                            db.SaveChanges();
                        }

                        var readBoardValue = new StatisticReadValueByBoard()
                        {
                            boardId = playerBoard.BoardId,
                            lastUpdate = playerBoard.LastUpdate,
                            rank = playerBoard.Rank,
                            score = playerBoard.Score,
                        };

                        readBoardValue.scores = playerBoard.Values.Where(x => statReqData.propertyIds.Contains(x.PropertyId)).Select(x => new StatisticReadValue()
                        {
                            propertyId = (byte)x.PropertyId,
                            value = JsonConvert.DeserializeObject<StatisticValueVariant>(x.ValueJSON),
                            rankingCriterionIndex = (byte)x.RankingCriterionIndex,
                            scoreLostForNextSlice = JsonConvert.DeserializeObject<StatisticValueVariant>(x.ScoreLostForNextSliceJSON),
                            sliceScore = JsonConvert.DeserializeObject<StatisticValueVariant>(x.SliceScoreJSON)
                        }).ToArray();

                        scoreListRead.scoresByBoard.Add(readBoardValue);
                    }
                }
            }

            return Result(playerStats);
        }

        public class ScoreListResultTemp
        {
            public List<ScoreListRead>? list { get; set; }
            public uint playersTotal { get; set; }
        }

        [RMCMethod(5)]
        public RMCResult ReadStatsLeaderboardByRange(int boardId, int columnId, int rankStart, int numRows, int filterId, int filterValue)
        {
            var playerStatsData = "64 00 00 00 50 A0 00 00 0A 00 4C 61 50 72 65 6D 69 65 72 00 01 00 00 00 40 00 00 00 01 00 00 00 00 3C 36 46 01 00 00 00 01 8F 2D 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 14 72 DD 6E 1F 00 00 00 48 BF 00 00 08 00 50 72 6F 6D 61 78 42 00 01 00 00 00 40 00 00 00 02 00 00 00 00 A0 37 46 01 00 00 00 01 E8 2D 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 B4 17 D7 6E 1F 00 00 00 9A 5D 00 00 0E 00 76 65 6E 67 65 61 6E 63 65 32 32 31 30 00 01 00 00 00 40 00 00 00 03 00 00 00 00 BC 39 46 01 00 00 00 01 6F 2E 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 6A 89 98 6E 1F 00 00 00 4A A3 00 00 07 00 4D 33 4C 4B 49 59 00 01 00 00 00 40 00 00 00 04 00 00 00 00 94 3B 46 01 00 00 00 01 E5 2E 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 53 7A E4 6E 1F 00 00 00 98 10 01 00 07 00 48 55 5A 55 4C 45 00 01 00 00 00 40 00 00 00 05 00 00 00 00 BC 3C 46 01 00 00 00 01 2F 2F 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 0A 0D E4 6E 1F 00 00 00 D4 B2 00 00 0B 00 42 75 6C 6C 65 74 38 33 75 6B 00 01 00 00 00 40 00 00 00 06 00 00 00 00 AC 3F 46 01 00 00 00 01 EB 2F 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 5B 35 9F 6E 1F 00 00 00 BB 5E 00 00 0C 00 44 61 67 61 73 68 69 36 36 36 39 00 01 00 00 00 40 00 00 00 07 00 00 00 00 60 41 46 01 00 00 00 01 58 30 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 69 4C 10 6F 1F 00 00 00 C5 96 01 00 0B 00 63 72 61 7A 79 61 6C 65 38 38 00 01 00 00 00 40 00 00 00 08 00 00 00 00 6C 42 46 01 00 00 00 01 9B 30 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 5B 74 93 70 1F 00 00 00 10 42 02 00 08 00 76 65 65 76 6F 69 72 00 01 00 00 00 40 00 00 00 09 00 00 00 00 84 42 46 01 00 00 00 01 A1 30 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 C4 4B 5B 71 1F 00 00 00 F9 02 01 00 09 00 61 6C 69 6B 6B 68 61 6E 00 01 00 00 00 40 00 00 00 0A 00 00 00 00 EC 42 46 01 00 00 00 01 BB 30 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 F5 EE CA 6E 1F 00 00 00 57 11 01 00 07 00 65 76 6B 31 69 64 00 01 00 00 00 40 00 00 00 0B 00 00 00 00 28 43 46 01 00 00 00 01 CA 30 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 40 02 ED 6E 1F 00 00 00 22 31 00 00 08 00 47 54 58 2D 52 55 53 00 01 00 00 00 40 00 00 00 0C 00 00 00 00 7C 43 46 01 00 00 00 01 DF 30 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 D6 4B 6B 70 1F 00 00 00 98 64 00 00 0E 00 53 63 4C 5F 45 64 65 6C 62 72 6F 63 6B 00 01 00 00 00 40 00 00 00 0D 00 00 00 00 C0 43 46 01 00 00 00 01 F0 30 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 1A 37 85 6E 1F 00 00 00 FF D7 00 00 08 00 73 68 65 6C 62 79 5F 00 01 00 00 00 40 00 00 00 0E 00 00 00 00 D0 43 46 01 00 00 00 01 F4 30 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 88 9B 50 70 1F 00 00 00 4A E0 00 00 0B 00 72 61 74 74 79 72 65 6E 65 65 00 01 00 00 00 40 00 00 00 0F 00 00 00 00 F4 43 46 01 00 00 00 01 FD 30 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 12 10 D4 70 1F 00 00 00 4B 42 01 00 06 00 4C 61 76 72 4B 00 01 00 00 00 40 00 00 00 10 00 00 00 00 A0 44 46 01 00 00 00 01 28 31 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 93 34 F5 70 1F 00 00 00 89 96 01 00 0A 00 6D 61 67 76 61 69 33 30 36 00 01 00 00 00 40 00 00 00 11 00 00 00 00 28 45 46 01 00 00 00 01 4A 31 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 29 04 9F 70 1F 00 00 00 1C DE 00 00 0D 00 4B 72 75 63 68 65 5F 54 65 62 79 61 00 01 00 00 00 40 00 00 00 12 00 00 00 00 BC 45 46 01 00 00 00 01 6F 31 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 23 8E 62 70 1F 00 00 00 9A 1E 01 00 0A 00 67 72 7A 6D 69 72 39 31 39 00 01 00 00 00 40 00 00 00 13 00 00 00 00 58 46 46 01 00 00 00 01 96 31 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 65 CB DC 70 1F 00 00 00 FA B4 00 00 07 00 50 75 67 6F 6E 65 00 01 00 00 00 40 00 00 00 14 00 00 00 00 5C 46 46 01 00 00 00 01 97 31 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 26 EC AE 6E 1F 00 00 00 A8 61 01 00 09 00 72 6F 64 64 61 76 69 64 00 01 00 00 00 40 00 00 00 15 00 00 00 00 74 46 46 01 00 00 00 01 9D 31 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 D8 24 89 70 1F 00 00 00 37 27 02 00 09 00 73 61 6C 76 61 7A 7A 7A 00 01 00 00 00 40 00 00 00 16 00 00 00 00 DC 46 46 01 00 00 00 01 B7 31 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 A5 DD 42 71 1F 00 00 00 D3 29 01 00 08 00 4B 44 33 35 35 34 32 00 01 00 00 00 40 00 00 00 17 00 00 00 00 EC 46 46 01 00 00 00 01 BB 31 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 1B 5A 32 6F 1F 00 00 00 18 73 01 00 09 00 61 6C 70 69 6E 6F 37 32 00 01 00 00 00 40 00 00 00 18 00 00 00 00 FC 46 46 01 00 00 00 01 BF 31 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 D6 E9 84 70 1F 00 00 00 DF 63 00 00 0D 00 53 70 65 65 64 79 53 43 31 39 37 38 00 01 00 00 00 40 00 00 00 19 00 00 00 00 3C 47 46 01 00 00 00 01 CF 31 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 66 91 82 6E 1F 00 00 00 FB E9 00 00 07 00 4A 61 6E 69 34 31 00 01 00 00 00 40 00 00 00 1A 00 00 00 00 78 47 46 01 00 00 00 01 DE 31 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 E6 B9 CC 6E 1F 00 00 00 88 E1 00 00 0C 00 52 69 6E 67 6F 5F 36 30 30 31 33 00 01 00 00 00 40 00 00 00 1B 00 00 00 00 B4 47 46 01 00 00 00 01 ED 31 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 57 52 43 70 1F 00 00 00 B8 6E 00 00 0B 00 6F 68 61 64 61 76 69 64 6F 76 00 01 00 00 00 40 00 00 00 1C 00 00 00 00 CC 47 46 01 00 00 00 01 F3 31 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 B7 EA CA 6E 1F 00 00 00 BF FB 00 00 0A 00 54 61 65 63 68 32 30 31 30 00 01 00 00 00 40 00 00 00 1D 00 00 00 00 3C 48 46 01 00 00 00 01 0F 32 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 1A E2 08 6F 1F 00 00 00 73 70 00 00 09 00 4C 61 72 73 39 38 39 38 00 01 00 00 00 40 00 00 00 1E 00 00 00 00 40 48 46 01 00 00 00 01 10 32 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 22 0C 61 70 1F 00 00 00 50 80 00 00 0A 00 53 63 68 61 61 72 6D 69 6E 00 01 00 00 00 40 00 00 00 1F 00 00 00 00 74 48 46 01 00 00 00 01 1D 32 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 09 FB A2 6E 1F 00 00 00 FF 1B 02 00 0B 00 6D 61 7A 61 63 69 6B 31 32 33 00 01 00 00 00 40 00 00 00 20 00 00 00 00 80 48 46 01 00 00 00 01 20 32 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 A9 D7 28 71 1F 00 00 00 0E 52 01 00 0A 00 6F 72 62 69 74 65 72 39 36 00 01 00 00 00 40 00 00 00 21 00 00 00 00 8C 48 46 01 00 00 00 01 23 32 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 2C 00 1F 71 1F 00 00 00 F5 03 01 00 0D 00 6D 61 72 69 6F 6D 61 74 68 69 61 73 00 01 00 00 00 40 00 00 00 22 00 00 00 00 10 49 46 01 00 00 00 01 44 32 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 B6 20 7B 70 1F 00 00 00 6D 94 00 00 09 00 72 65 6D 73 31 39 37 31 00 01 00 00 00 40 00 00 00 23 00 00 00 00 14 49 46 01 00 00 00 01 45 32 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 27 F0 8A 6E 1F 00 00 00 91 A6 00 00 0E 00 41 64 72 65 6E 61 6C 69 4E 6F 73 39 33 00 01 00 00 00 40 00 00 00 24 00 00 00 00 20 49 46 01 00 00 00 01 48 32 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 35 3A CF 6E 1F 00 00 00 26 B8 00 00 09 00 61 6E 61 6E 69 6A 69 6E 00 01 00 00 00 40 00 00 00 25 00 00 00 00 A8 49 46 01 00 00 00 01 6A 32 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 4E E9 0E 71 1F 00 00 00 BC 70 01 00 0B 00 50 68 30 65 6E 69 78 5F 37 34 00 01 00 00 00 40 00 00 00 26 00 00 00 00 54 4A 46 01 00 00 00 01 95 32 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 50 A9 A2 70 1F 00 00 00 01 63 00 00 0A 00 70 61 64 69 61 64 69 34 35 00 01 00 00 00 40 00 00 00 27 00 00 00 00 B0 4A 46 01 00 00 00 01 AC 32 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 59 F6 A8 6E 1F 00 00 00 7F 75 00 00 0F 00 4E 69 6B 6F 6C 79 61 5F 4F 74 72 75 62 61 00 01 00 00 00 40 00 00 00 28 00 00 00 00 B4 4A 46 01 00 00 00 01 AD 32 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 DF F1 10 71 1F 00 00 00 8E 4E 00 00 08 00 63 68 69 72 69 6C 37 00 01 00 00 00 40 00 00 00 29 00 00 00 00 CC 4A 46 01 00 00 00 01 B3 32 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 BB 41 D5 6E 1F 00 00 00 0E 89 01 00 07 00 54 49 47 52 2D 31 00 01 00 00 00 40 00 00 00 2A 00 00 00 00 D4 4A 46 01 00 00 00 01 B5 32 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 E5 09 47 70 1F 00 00 00 F5 58 00 00 09 00 73 68 69 66 74 5F 30 31 00 01 00 00 00 40 00 00 00 2B 00 00 00 00 E8 4A 46 01 00 00 00 01 BA 32 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 DC EC 9A 6E 1F 00 00 00 9B 87 00 00 09 00 73 6B 77 61 73 6A 65 72 00 01 00 00 00 40 00 00 00 2C 00 00 00 00 00 4B 46 01 00 00 00 01 C0 32 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 98 FE 88 6E 1F 00 00 00 8A BB 01 00 0D 00 52 75 73 5F 43 72 61 73 68 5F 41 53 00 01 00 00 00 40 00 00 00 2D 00 00 00 00 08 4B 46 01 00 00 00 01 C2 32 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 33 25 83 70 1F 00 00 00 1D 2D 01 00 08 00 53 74 69 67 32 36 35 00 01 00 00 00 40 00 00 00 2E 00 00 00 00 24 4B 46 01 00 00 00 01 C9 32 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 4B CE 1C 6F 1F 00 00 00 2D B1 00 00 0B 00 44 64 72 34 69 67 47 6F 63 68 00 01 00 00 00 40 00 00 00 2F 00 00 00 00 2C 4B 46 01 00 00 00 01 CB 32 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 63 30 17 71 1F 00 00 00 10 F6 00 00 09 00 73 65 62 6C 65 72 75 73 00 01 00 00 00 40 00 00 00 30 00 00 00 00 34 4B 46 01 00 00 00 01 CD 32 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 E0 72 CD 6E 1F 00 00 00 49 B0 00 00 0B 00 63 6F 6C 64 65 63 68 6F 65 73 00 01 00 00 00 40 00 00 00 31 00 00 00 00 44 4B 46 01 00 00 00 01 D1 32 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 5F 05 1C 6F 1F 00 00 00 8F 90 00 00 0B 00 53 61 6E 52 61 63 65 72 35 32 00 01 00 00 00 40 00 00 00 32 00 00 00 00 74 4B 46 01 00 00 00 01 DD 32 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 28 C5 9A 6E 1F 00 00 00 8E 7F 00 00 09 00 79 75 72 69 73 74 61 73 00 01 00 00 00 40 00 00 00 33 00 00 00 00 AC 4B 46 01 00 00 00 01 EB 32 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 84 75 FD 6E 1F 00 00 00 F9 48 01 00 09 00 44 61 72 6B 6F 37 33 35 00 01 00 00 00 40 00 00 00 34 00 00 00 00 AC 4B 46 01 00 00 00 01 EB 32 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 55 1E 17 6F 1F 00 00 00 3F 92 01 00 07 00 44 65 6E 6E 6F 79 00 01 00 00 00 40 00 00 00 35 00 00 00 00 F8 4B 46 01 00 00 00 01 FE 32 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 B6 0C AD 70 1F 00 00 00 E8 1B 02 00 0F 00 74 69 61 67 6F 70 65 72 65 69 72 61 35 37 00 01 00 00 00 40 00 00 00 36 00 00 00 00 14 4C 46 01 00 00 00 01 05 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 E7 36 3D 71 1F 00 00 00 28 E7 01 00 0B 00 61 6C 62 65 72 74 6F 32 32 38 00 01 00 00 00 40 00 00 00 37 00 00 00 00 20 4C 46 01 00 00 00 01 08 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 A1 37 53 71 1F 00 00 00 90 D2 01 00 0F 00 4D 61 73 74 65 72 64 72 76 72 61 63 65 72 00 01 00 00 00 40 00 00 00 38 00 00 00 00 34 4C 46 01 00 00 00 01 0D 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 DE 0A A5 70 1F 00 00 00 6B A7 01 00 0E 00 64 65 6D 6F 6E 30 32 30 33 32 30 31 30 00 01 00 00 00 40 00 00 00 39 00 00 00 00 38 4C 46 01 00 00 00 01 0E 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 5D 83 C4 70 1F 00 00 00 D3 6F 00 00 07 00 4A 61 63 6B 76 38 00 01 00 00 00 40 00 00 00 3A 00 00 00 00 44 4C 46 01 00 00 00 01 11 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 B0 8C 86 6E 1F 00 00 00 35 D9 01 00 0D 00 58 74 72 65 6D 65 5F 47 68 6F 73 74 00 01 00 00 00 40 00 00 00 3B 00 00 00 00 9C 4C 46 01 00 00 00 01 27 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 59 E1 38 71 1F 00 00 00 6C CA 00 00 0F 00 73 75 70 65 72 66 72 61 6E 6B 69 65 38 36 00 01 00 00 00 40 00 00 00 3C 00 00 00 00 A8 4C 46 01 00 00 00 01 2A 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 DD 36 A3 6E 1F 00 00 00 F7 F6 00 00 06 00 54 65 75 7A 79 00 01 00 00 00 40 00 00 00 3D 00 00 00 00 CC 4C 46 01 00 00 00 01 33 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 57 34 B5 6E 1F 00 00 00 FE C8 01 00 0A 00 43 45 4D 45 48 31 39 30 35 00 01 00 00 00 40 00 00 00 3E 00 00 00 00 DC 4C 46 01 00 00 00 01 37 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 63 31 F7 70 1F 00 00 00 BA CE 01 00 0F 00 42 52 49 4C 4C 45 4E 53 43 48 52 55 42 41 00 01 00 00 00 40 00 00 00 3F 00 00 00 00 E4 4C 46 01 00 00 00 01 39 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 46 BE 38 71 1F 00 00 00 29 77 00 00 0A 00 53 6D 30 6B 65 79 34 30 38 00 01 00 00 00 40 00 00 00 40 00 00 00 00 10 4D 46 01 00 00 00 01 44 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 8B 7E 86 6E 1F 00 00 00 C2 63 00 00 0A 00 73 6F 6E 79 70 72 6F 66 69 00 01 00 00 00 40 00 00 00 41 00 00 00 00 2C 4D 46 01 00 00 00 01 4B 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 EE FC 8C 6E 1F 00 00 00 BD 26 00 00 0C 00 44 6F 63 74 6F 72 44 65 6D 6F 6E 00 01 00 00 00 40 00 00 00 42 00 00 00 00 38 4D 46 01 00 00 00 01 4E 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 1E C1 88 6E 1F 00 00 00 38 62 00 00 06 00 53 79 68 6F 6E 00 01 00 00 00 40 00 00 00 43 00 00 00 00 5C 4D 46 01 00 00 00 01 57 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 A1 27 2D 6F 1F 00 00 00 FC DC 00 00 0B 00 68 75 73 64 61 6E 69 65 6C 6F 00 01 00 00 00 40 00 00 00 44 00 00 00 00 68 4D 46 01 00 00 00 01 5A 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 FA FC B0 6E 1F 00 00 00 AD 9E 01 00 0D 00 67 75 62 61 6E 63 68 69 6B 6F 66 66 00 01 00 00 00 40 00 00 00 45 00 00 00 00 68 4D 46 01 00 00 00 01 5A 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 01 05 43 71 1F 00 00 00 19 BD 00 00 07 00 42 65 6E 6E 65 62 00 01 00 00 00 40 00 00 00 46 00 00 00 00 84 4D 46 01 00 00 00 01 61 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 31 E7 92 6E 1F 00 00 00 94 D4 01 00 0B 00 64 61 66 66 69 74 6D 61 6C 79 00 01 00 00 00 40 00 00 00 47 00 00 00 00 A0 4D 46 01 00 00 00 01 68 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 F1 C1 E6 70 1F 00 00 00 26 85 00 00 08 00 4E 45 58 5F 37 35 30 00 01 00 00 00 40 00 00 00 48 00 00 00 00 A4 4D 46 01 00 00 00 01 69 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 49 15 53 71 1F 00 00 00 CA 8D 01 00 0E 00 63 72 61 73 68 62 61 6E 64 69 66 61 6E 00 01 00 00 00 40 00 00 00 49 00 00 00 00 A8 4D 46 01 00 00 00 01 6A 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 40 E2 5C 70 1F 00 00 00 39 DB 01 00 08 00 4A 6F 6B 65 4F 4F 37 00 01 00 00 00 40 00 00 00 4A 00 00 00 00 A8 4D 46 01 00 00 00 01 6A 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 A8 54 31 71 1F 00 00 00 A2 6D 00 00 0B 00 4C 65 78 5F 63 6F 6F 70 65 72 00 01 00 00 00 40 00 00 00 4B 00 00 00 00 B4 4D 46 01 00 00 00 01 6D 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 63 A8 86 6E 1F 00 00 00 58 F9 00 00 0C 00 73 75 70 65 72 76 61 74 6D 61 6E 00 01 00 00 00 40 00 00 00 4C 00 00 00 00 C0 4D 46 01 00 00 00 01 70 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 9C 6A F7 70 1F 00 00 00 EC 5F 00 00 08 00 78 69 6C 65 66 31 31 00 01 00 00 00 40 00 00 00 4D 00 00 00 00 C4 4D 46 01 00 00 00 01 71 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 7A 0A 37 71 1F 00 00 00 90 8C 00 00 0C 00 6D 61 78 31 39 39 36 6B 72 69 6B 00 01 00 00 00 40 00 00 00 4E 00 00 00 00 D8 4D 46 01 00 00 00 01 76 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 6E 1C 87 6E 1F 00 00 00 1E D3 00 00 09 00 4C 75 67 61 6C 6F 63 6F 00 01 00 00 00 40 00 00 00 4F 00 00 00 00 E8 4D 46 01 00 00 00 01 7A 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 7B A0 CE 6E 1F 00 00 00 2D 2F 02 00 09 00 48 4F 59 49 31 39 37 36 00 01 00 00 00 40 00 00 00 50 00 00 00 00 E8 4D 46 01 00 00 00 01 7A 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 12 77 59 71 1F 00 00 00 57 64 00 00 08 00 42 75 67 73 79 30 32 00 01 00 00 00 40 00 00 00 51 00 00 00 00 14 4E 46 01 00 00 00 01 85 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 10 D2 8C 6E 1F 00 00 00 91 82 00 00 0B 00 6A 6C 74 5F 6D 78 35 5F 30 33 00 01 00 00 00 40 00 00 00 52 00 00 00 00 14 4E 46 01 00 00 00 01 85 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 DC 4A DB 6E 1F 00 00 00 37 B4 00 00 0E 00 62 75 73 68 6E 65 6C 6C 73 6F 75 74 68 00 01 00 00 00 40 00 00 00 53 00 00 00 00 34 4E 46 01 00 00 00 01 8D 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 F6 DC FC 6E 1F 00 00 00 39 91 00 00 06 00 6B 4E 52 69 6B 00 01 00 00 00 40 00 00 00 54 00 00 00 00 3C 4E 46 01 00 00 00 01 8F 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 E3 FA 88 6E 1F 00 00 00 53 FA 00 00 08 00 62 72 61 6E 6E 65 79 00 01 00 00 00 40 00 00 00 55 00 00 00 00 3C 4E 46 01 00 00 00 01 8F 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 C4 79 ED 6E 1F 00 00 00 1C 2B 01 00 0C 00 67 65 6E 69 75 73 65 72 6D 61 6E 00 01 00 00 00 40 00 00 00 56 00 00 00 00 70 4E 46 01 00 00 00 01 9C 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 A6 55 0C 6F 1F 00 00 00 7E 79 00 00 07 00 62 6F 6F 6E 78 32 00 01 00 00 00 40 00 00 00 57 00 00 00 00 80 4E 46 01 00 00 00 01 A0 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 75 48 83 6E 1F 00 00 00 90 5A 01 00 0B 00 64 6F 70 65 6D 61 6E 69 61 31 00 01 00 00 00 40 00 00 00 58 00 00 00 00 80 4E 46 01 00 00 00 01 A0 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 26 DD 3E 6F 1F 00 00 00 F8 85 00 00 0A 00 53 74 65 76 6F 74 65 30 38 00 01 00 00 00 40 00 00 00 59 00 00 00 00 AC 4E 46 01 00 00 00 01 AB 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 43 23 4B 70 1F 00 00 00 48 69 00 00 09 00 6F 73 73 69 6F 6E 32 39 00 01 00 00 00 40 00 00 00 5A 00 00 00 00 C8 4E 46 01 00 00 00 01 B2 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 A4 C2 9A 6E 1F 00 00 00 8C F4 00 00 0C 00 62 65 6E 6A 69 32 37 31 31 39 36 00 01 00 00 00 40 00 00 00 5B 00 00 00 00 D0 4E 46 01 00 00 00 01 B4 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 CE 22 4F 71 1F 00 00 00 3C 25 00 00 0D 00 71 77 72 74 74 79 75 69 31 32 33 34 00 01 00 00 00 40 00 00 00 5C 00 00 00 00 E8 4E 46 01 00 00 00 01 BA 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 8F 45 AC 6E 1F 00 00 00 26 B5 00 00 0E 00 70 61 77 65 6C 64 72 69 76 65 72 37 31 00 01 00 00 00 40 00 00 00 5D 00 00 00 00 E8 4E 46 01 00 00 00 01 BA 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 94 FE 08 6F 1F 00 00 00 4F 78 00 00 09 00 72 61 62 62 61 6E 38 31 00 01 00 00 00 40 00 00 00 5E 00 00 00 00 F4 4E 46 01 00 00 00 01 BD 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 5F 3C A5 6E 1F 00 00 00 CF 72 01 00 09 00 4D 61 68 73 75 6D 38 38 00 01 00 00 00 40 00 00 00 5F 00 00 00 00 F8 4E 46 01 00 00 00 01 BE 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 B0 11 60 70 1F 00 00 00 82 74 00 00 07 00 53 6D 61 73 68 44 00 01 00 00 00 40 00 00 00 60 00 00 00 00 14 4F 46 01 00 00 00 01 C5 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 4E 36 95 6E 1F 00 00 00 5F B8 00 00 0D 00 6B 6F 62 65 62 72 79 61 6E 74 31 36 00 01 00 00 00 40 00 00 00 61 00 00 00 00 1C 4F 46 01 00 00 00 01 C7 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 22 52 B9 6E 1F 00 00 00 67 7C 01 00 0C 00 43 61 70 74 5F 53 63 6F 72 63 68 00 01 00 00 00 40 00 00 00 62 00 00 00 00 24 4F 46 01 00 00 00 01 C9 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 E6 16 5E 70 1F 00 00 00 CC 76 01 00 08 00 4B 61 70 69 36 35 30 00 01 00 00 00 40 00 00 00 63 00 00 00 00 30 4F 46 01 00 00 00 01 CC 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 04 A5 42 71 1F 00 00 00 D8 6F 00 00 08 00 7A 6F 72 62 6D 61 61 00 01 00 00 00 40 00 00 00 64 00 00 00 00 78 4F 46 01 00 00 00 01 DE 33 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 A4 AA 92 6E 1F 00 00 00 A6 29 00 00";
            var stream = new MemoryStream(Helper.ParseByteArray(playerStatsData));
            var rewardList = DDLSerializer.ReadObject<ScoreListResultTemp>(stream);

            var playerStats = new List<ScoreListRead>();
            uint playersTotal = 0;

            using (var db = DBHelper.GetDbContext(Context.Handler.Factory.Item1))
            {
                var playerBoards = db.PlayerStatisticBoards
                    .Where(x => x.BoardId == boardId)
                    .Take(numRows);

                foreach (var board in playerBoards)
                {
                    var scoreList = new ScoreListRead();
                    {
                        var player = NetworkPlayers.GetPlayerInfoByPID(board.PlayerId);

                        if (player == null)
                            continue;

                        scoreList = new ScoreListRead();
                        scoreList.pid = board.PlayerId;
                        scoreList.pname = player.Name;
                    }

                    var statValueByBoard = new StatisticReadValueByBoard()
                    {
                        boardId = board.BoardId,
                        lastUpdate = board.LastUpdate,
                        rank = 0,
                        score = 0,
                    };
                    scoreList.scoresByBoard.Add(statValueByBoard);

                    var boardValue = db.PlayerStatisticBoardValues
                        .Where(x => x.PlayerBoardId == board.Id && x.PropertyId == columnId)
                        .SingleOrDefault(x => x.PropertyId == columnId);
                    if (boardValue != null)
                    {
                        var rv = new StatisticReadValue()
                        {
                            propertyId = (byte)boardValue.PropertyId,
                            value = JsonConvert.DeserializeObject<StatisticValueVariant>(boardValue.ValueJSON),
                            rankingCriterionIndex = (byte)boardValue.RankingCriterionIndex,
                            scoreLostForNextSlice = JsonConvert.DeserializeObject<StatisticValueVariant>(boardValue.ScoreLostForNextSliceJSON),
                            sliceScore = JsonConvert.DeserializeObject<StatisticValueVariant>(boardValue.SliceScoreJSON)
                        };
                        statValueByBoard.scores.Add(rv);

                        switch ((VariantType)rv.value.typeValue)
                        {
                            case VariantType.int32:
                                statValueByBoard.score = rv.value.valueInt32;
                                break;
                            case VariantType.int64:
                                statValueByBoard.score = rv.value.valueInt64;
                                break;
                            case VariantType.Float:
                            case VariantType.Double:
                                statValueByBoard.score = (float)rv.value.valueDouble;
                                break;
                        }

                        playerStats.Add(scoreList);
                    }
                }

                var leaderBoardStat = SeedStatistics.AllStatisticDescriptions.FirstOrDefault(x => x.statBoard == boardId && x.statInBoardId == columnId);
                if (leaderBoardStat.statRankingOrder == RankingOrder.Ascending)
                    playerStats.Sort((a, b) => (int)(a.scoresByBoard.First().score - b.scoresByBoard.First().score));
                else
                    playerStats.Sort((a, b) => (int)(b.scoresByBoard.First().score - a.scoresByBoard.First().score));

                // perform ranking
                var rank = rankStart;
                foreach (var score in playerStats)
                {
                    if (score.scoresByBoard.First().score != 0)
                    {
                        score.scoresByBoard.First().rank = rank;
                        rank++;
                    }
                }

                playersTotal = (uint)playerBoards.Count();
            }

            return Result(new { a = playerStats, b = playersTotal });
        }

        [RMCMethod(8)]
        public RMCResult ReadStatsLeaderboardByPIDs(IEnumerable<LeaderboardData> dataList, List<uint> playerPIDs)
        {
            var playerStats = new List<ScoreListRead>();
            uint playersTotal = 0;

            using (var db = DBHelper.GetDbContext(Context.Handler.Factory.Item1))
            {
                foreach (var data in dataList)
                {
                    var playerBoards = db.PlayerStatisticBoards
                        .Where(x => x.BoardId == data.boardId)
                        .Where(x => playerPIDs.Contains(x.PlayerId));

                    playersTotal += (uint)playerBoards.Count();
                }
            }

            return Result(new { a = playerStats, b = playersTotal });
        }

        [RMCMethod(10)]
        public RMCResult ReadStatsLeaderboardKeyRanks(int boardId, int columnId)
        {
            var playerStats = new List<ScoreListRead>();
            return Result(playerStats);
        }
    }
}
